<!DOCTYPE HTML>
<html class="app">

<head>
    <meta charset="utf-8">
    <title>Views</title>
    <link rel="stylesheet" href="styles/main.css">
    <link href="https://fonts.googleapis.com/css?family=Roboto:100,300" rel="stylesheet">
    <style>
	    
    </style>
</head>

<body>
	<div class="content">
		<div class="input-area">
			<div id="input-row1">
				<div class="title-text">What do you need to do today?</div>
				<input class="input-add" type="text"><button id="add">Add</button>
				<div class="error hide"><sup>*</sup>please enter a task</div>
			</div>
			
		</div>
		<div class="list-area">
			<div class="list hide">
				<div class="list-title">To do </div>
				<ul id="todo-list"></ul>
			</div>
			<div class="list hide">
				<div class="list-title">Completed</div>
				<ul id="todo-list-completed"></ul>
			</div>
		</div>
	</div>


	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
	<script type="text/javascript" src="../shared/js/utils.js"></script>
	<script type="text/javascript" src="../shared/js/events.js"></script>
	<script type="text/javascript" src="../shared/js/models.js"></script>
	<script type="text/javascript" src="../shared/js/views.js"></script>
	<script type="text/javascript" src="http://underscorejs.org/underscore.js"></script>
	<script type="text/javascript" src="http://backbonejs.org/backbone.js"></script>
	<script>

		// Some sample of how to use our new Model class from our framework
		var TodoItem = SKFramework.Model.extend({
				initialize: function(){
					console.log('hi');
					console.log(TodoItem.prototype.initialize);
					this.set('status', 0);
				},
				changeStatus: function(_status){
					if(typeof _status == "number"){
						if(_status <= 0){
							_status = 0;
						}else if( _status > 1){
							_status = 1;
						}
						this.set('status', _status);
					}
					return this;
				},
				changeLabel: function(_label){
					this.set('label', String(_label))
				}
			});

		var MyView = SKFramework.View.extend({
			initialize: function(_el, model){
				this.setElement(_el);
				this.render = this.render.bind(this);
				this.onDelete = this.onDelete.bind(this);
				this.onEdit = this.onEdit.bind(this);
				this.onSave = this.onSave.bind(this);
				this.onStatusChange = this.onStatusChange.bind(this);
				this.model = model;
				this.state = {
					mode: 'view'
				};
				this.templates = { 
					view: '<input class="check" id="status" type="checkbox"> <div id="label"></div>  <button id="edit">Edit</button><button id="delete">Delete</button>',
					edit: '<input class="check" id="status" type="checkbox"> <input id="label-edit"> <button id="save">Save</button><button id="delete">Delete</button>'
				};
				this.addListeners();
			},
			addListeners: function(){
				$(this.el).on('click', '#delete', this.onDelete); 
				$(this.el).on('click', '#edit', this.onEdit); 
				$(this.el).on('click', '#save', this.onSave); 
				$(this.el).on('click', '#status', this.onStatusChange); 
			},
			onStatusChange: function(){
				if(this.el.querySelector('input#status').checked){
					this.model.changeStatus(1);
				}
				else{
					this.model.changeStatus(0);
				}
				this.emit('statusChange', {target: this});
			},
			onEdit: function(){
				this.state = { mode: 'edit' };
				this.render();
			},
			onSave: function(){
				this.model.set('label', this.el.querySelector('#label-edit').value);
				this.state = { mode: 'view' };
				this.render();
			},
			onDelete: function(){
				var parentEl = this.el.parentNode;
				parentEl.removeChild(this.el);
				this.emit('delete', { target: this });
			},
			render: function(){
				if(this.state.mode === 'view'){
					this.el.innerHTML = this.templates.view;
					this.el.querySelector('#label').innerHTML = this.model.get('label');
				}
				else if(this.state.mode === 'edit'){
					this.el.innerHTML = this.templates.edit;
					this.el.querySelector('#label-edit').value = this.model.get('label');
				}
				if(this.model.get('status') === 1){
					this.el.querySelector('input#status').checked = true;
				}
				else{
					this.el.querySelector('input#status').checked = false;
				}
				return this.el;
			}
		})

		var AppView = SKFramework.View.extend({
			initialize: function(_el){
				this.setElement(_el);
				this.createOnClick = this.createOnClick.bind(this);
				this.onDelete = this.onDelete.bind(this);
				this.render = this.render.bind(this);
				this.checkListItems = this.checkListItems.bind(this);
				this.clearError = this.clearError.bind(this);
				
				this.listComplete = this.el.querySelector('#todo-list-completed');
				this.listTodo = this.el.querySelector('#todo-list');
				this.todoList = [];
				this.addListeners();
			},
			addListeners: function(){
				$(this.el).on('click', '#add', this.createOnClick); 
				$(this.el).on('click', '#input-row1 input', this.clearError); 				
			},
			createOnClick: function(){
				if(this.el.querySelector('#input-row1 input').value == '') {
					this.el.querySelector('.error').classList.remove('hide');
				}
				else {
					// create a model and set it
					var todoItem1 = new TodoItem();
				
					todoItem1.set('label', this.el.querySelector('#input-row1 input').value);
					this.el.querySelector('#input-row1 input').value = '';

					// create a view, add delete event listener, add to an array of views, render and add to DOM
					var newListElement = document.createElement('li');
					this.newView = new MyView(newListElement, todoItem1);

					this.newView.on('delete', this.onDelete);
					this.newView.on('statusChange', this.render); 

					this.todoList.push(this.newView);
					this.listTodo.appendChild(this.newView.render());
					this.checkListItems();
				}
			},
			clearError: function(){
					this.el.querySelector('.error').classList.add('hide');
			},
			onDelete: function(event){
				var selectedView = event.target;
				var viewIndex = this.todoList.indexOf(selectedView);
				this.todoList.splice(viewIndex, 1);
				console.log(this.todoList);
				this.checkListItems();
			},
			checkListItems: function(){
				this.listComplete.hasChildNodes()?this.listComplete.parentNode.classList.remove('hide'):this.listComplete.parentNode.classList.add('hide');
				this.listTodo.hasChildNodes()?this.listTodo.parentNode.classList.remove('hide'):this.listTodo.parentNode.classList.add('hide');
				
			},
			render: function(){
				this.listTodo.innerHTML = '';
				for(var i=0; i<this.todoList.length; i++){
					if(this.todoList[i].model.get('status') === 1){
						this.listComplete.appendChild(this.todoList[i].render());	
					}
					else{
						this.listTodo.appendChild(this.todoList[i].render());	
					}
				}
				this.checkListItems();
			}
		})


		//create new instance of myview
		var myViewObj = new AppView(document.body);

	</script>
</body>

</html>